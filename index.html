<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Asistente – CEVP</title>
  <style>
    :root{
  /* Marca CEVP */
  --brand:#971B3F;         /* granate principal */
  --brand-50:#F8E9EF;      /* tinte para burbujas/chips */
  --brand-200:#E9C8D3;     /* borde suave del tinte */

  /* Acento (iconos/enlaces) */
  --accent:#97C10E;        /* verde lima del botón Calendario */

  /* Base UI */
  --bg:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --border:#e5e7eb;

  /* Tipografía fluida y legible en móvil */
  --fs: clamp(17px, 3.2vw, 19px);
}

/* ------ no cambia la estructura, solo colores ------ */

body{ background:var(--bg); color:var(--text); font-size:var(--fs); }

.header{
  background: linear-gradient(180deg, #ffffff 60%, var(--brand-50));
  border-bottom:1px solid var(--brand-200);
}


.title{ font-weight:800; }
.subtitle{ color:var(--muted); }

.bubble.bot{
  background:var(--brand-50);      /* bot en tinte granate */
  border:1px solid var(--brand-200);
  color:var(--text);
}
.bubble.user{
  background:var(--brand);         /* usuario en granate sólido */
  color:#fff;
}

.chip{
  background:var(--brand-50);
  border:1px solid var(--brand-200);
  color:#1f2937;
}
button{               /* botón Enviar */
  background:var(--brand);
  color:#fff;
}
button:hover{ filter:brightness(0.95); }

.toolbtn{            /* “Borrar conversación” */
  background:#f7f7f8;
  border:1px solid var(--border);
  color:#1f2937;
}

/* Enlaces como el acento verde de la web */
a{ color:var(--accent); }
a:hover{ text-decoration:underline; }

  </style>
  <!-- Fuse.js para búsqueda difusa -->
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Escudo CEVP">
        <div>
          <div class="title">Asistente – CEVP</div>
          <div class="subtitle">Torre Pacheco · Secretaría (9:00–18:00)</div>
        </div>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="inputbar">
      <input id="msg" type="text" placeholder="Escribe tu pregunta (ej.: comedor, calendario, libros…)" aria-label="Escribe tu pregunta" />
      <button id="send" aria-label="Enviar mensaje">Enviar</button>
    </div>

    <div class="tools">
      <button class="toolbtn" id="clear">Borrar conversación</button>
    </div>

    <div class="footer">
      ⚠️ No compartas datos personales. Para gestiones con datos, usa el correo oficial del centro.
    </div>
  </div>

  <script>
    const BASE = 'https://web.virgendelpasico.net';
    const LS_KEY = 'cevp_chat_history_v1';
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');

    let awaitingConsentForChips = false;
    let fuse = null; // buscador
    let data = [];   // FAQs

    // 1) Cargar faqs.json (mismo directorio)
    fetch('./faqs.json')
      .then(r => r.json())
      .then(json => {
        data = json;
        fuse = new Fuse(data, {
          includeScore: true,
          threshold: 0.45,
          keys: [
            {name:'pregunta', weight:0.6},
            {name:'tema',      weight:0.2},
            {name:'etiquetas', weight:0.2},
          ]
        });
        init();
      })
      .catch(() => init());

    // 2) Utilidades
    function loadHistory(){ try{ (JSON.parse(localStorage.getItem(LS_KEY)||'[]')).forEach(m=>addBubble(m.html,m.who,false)); }catch{} }
    function saveMessage(html,who){ try{ const d=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); d.push({html,who,ts:Date.now()}); localStorage.setItem(LS_KEY,JSON.stringify(d)); }catch{} }
    function clearHistory(){ localStorage.removeItem(LS_KEY); chat.innerHTML=''; greet(); }

    function fixLinks(scope){
      scope.querySelectorAll('a[href]').forEach(a=>{
        let href = a.getAttribute('href')||'';
        if (href.startsWith('/')) { href = BASE + href; a.setAttribute('href', href); }
        if (/^(https?:|mailto:|tel:)/i.test(href)) { a.target = '_blank'; a.rel = 'noopener noreferrer'; }
      });
    }

    function addBubble(html, who='bot', save=true){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='user'?'user':'');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who==='user'?'user':'bot');
      b.innerHTML = html;
      row.appendChild(b);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      fixLinks(b);
      if (save) saveMessage(html, who);
      return b;
    }

    function addChips(labels){
      if (!labels || !labels.length) return;
      const wrap = document.createElement('div'); wrap.className = 'chips';
      labels.forEach(t => {
        const c = document.createElement('div'); c.className='chip'; c.textContent=t;
        c.onclick = () => handleChip(t);
        wrap.appendChild(c);
      });
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    function getSuggestions(){
      return ['Horarios','Calendario','Comedor','Extraescolares','Libros y material','Transporte','Hablar con una persona'];
    }

    function handleChip(t){
      if (t==='Hablar con una persona'){
        addBubble(t,'user');
        addBubble('📞 Secretaría: <a href="tel:+34968336433">968 33 64 33</a> · <a href="mailto:secretaria@virgendelpasico.net">secretaria@virgendelpasico.net</a> (9:00–14:00)','bot');
        return;
      }
      addBubble(t,'user');
      const reply = respond(t);
      showReply(reply);
    }

    function greet(){
      addBubble('👋 Hola, soy el asistente del cole. Dime qué necesitas y te ayudo.<br><br>¿Quieres que te muestre algunos temas frecuentes? Responde <b>“Sí”</b> (o “vale”, “ok”).');
      awaitingConsentForChips = true;
    }

    function init(){
      const hasHist = !!localStorage.getItem(LS_KEY);
      if (hasHist) loadHistory(); else greet();
    }

    function showReply(obj){
      addBubble(obj.html,'bot');
      if (obj.options?.length) addChips(obj.options);
    }

    function respond(text){
      if (awaitingConsentForChips){
        const t = text.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
        const afirm = ['si','sí','vale','ok','de acuerdo','claro','por supuesto'];
        const neg   = ['no','nop','negativo'];
        if (afirm.includes(t)) {
          awaitingConsentForChips = false;
          return { html:'Perfecto 👍 Te dejo algunos temas por si te orienta 👇', options: getSuggestions() };
        } else if (neg.includes(t)) {
          awaitingConsentForChips = false;
          return { html:'Perfecto, pues dime qué necesitas. 🙂', options: [] };
        } else {
          awaitingConsentForChips = false;
        }
      }

      if (/(humano|persona|secretar)/i.test(text)) {
        return { html:'📞 Secretaría: <a href="tel:+34968336433">968 33 64 33</a> · <a href="mailto:secretaria@virgendelpasico.net">secretaria@virgendelpasico.net</a> (9:00–14:00)', options: [] };
      }

      if (!fuse || !data.length){
        return { html:'Ahora mismo no tengo la base cargada. Prueba en unos segundos.', options: getSuggestions() };
      }

      const res = fuse.search(text).slice(0,1);
      if (!res.length || res[0].score > 0.55){
        return { html:'No estoy del todo seguro 🤔. Prueba con una palabra clave (p. ej., “comedor”, “calendario”) o dime un poco más.', options: getSuggestions() };
      }
      const hit = res[0].item;
      return { html: hit.respuesta, options: [] };
    }

    sendBtn.onclick = () => {
      const text = (input.value || '').trim(); if (!text) return;
      addBubble(text,'user'); input.value = '';
      const reply = respond(text); showReply(reply);
    };
    input.addEventListener('keydown', e => { if (e.key==='Enter') sendBtn.click(); });
    clearBtn.addEventListener('click', clearHistory);

    document.addEventListener('click', e => {
      const a = e.target.closest('a[href]'); if(!a) return;
      e.preventDefault();
      const href = a.getAttribute('href') || '';
      const url = href.startsWith('/') ? (BASE + href) : href;
      window.open(url, '_blank','noopener');
    });
  </script>
</body>
</html>
