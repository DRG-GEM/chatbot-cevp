<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Asistente ‚Äì CEVP</title>
  <style>
    :root{
      /* Colores corporativos */
      --brand:#971B3F;        /* granate principal */
      --brand-50:#FAEEF3;     /* tinte claro para burbujas/chips */
      --brand-200:#E8C9D6;    /* borde suave del tinte */
      --accent:#97C10E;       /* verde lima (acento/enlaces) */

      /* Base UI */
      --bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --fs:clamp(17px,3.2vw,19px);  /* legible en m√≥vil */
    }

    /* Reset m√≠nimo + no interferir con estilos externos */
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size:var(--fs); line-height:1.5;
    }

    /* Contenedor */
    .c-wrap{ width:100%; max-width:820px; margin:0 auto; padding:12px; }

    /* Cabecera (sutil toque de marca) */
    .c-header{
      display:flex; align-items:center; gap:.75rem;
      padding:10px 0; border-bottom:1px solid var(--brand-200);
      background:linear-gradient(180deg,#fff 60%, var(--brand-50));
      position:sticky; top:0; z-index:5;
    }
    .c-brand{ display:flex; align-items:center; gap:.75rem; }
    .c-brand img{ width:40px; height:40px; border-radius:8px; object-fit:cover; }
    .c-title{ font-weight:800; }
    .c-sub{ color:var(--muted); font-size:.9em; }

    /* √Årea del chat */
    .c-chat{ margin-top:12px; max-height:60vh; overflow-y:auto; padding-right:2px; }

    /* Burbujas (clases aisladas para no romper nada) */
    .c-row{ display:flex; gap:8px; margin:.65rem 0; }
    .c-row.c-user{ justify-content:flex-end; }
    .c-bubble{
      display:inline-block; max-width:92%;
      padding:.75rem .95rem; border-radius:14px;
      font-size:1em; line-height:1.5; word-wrap:break-word; white-space:normal;
    }
    .c-bot{ background:var(--brand-50); border:1px solid var(--brand-200); color:var(--text); }
    .c-user .c-bubble{ background:var(--brand); color:#fff; }

    /* Chips sugeridos */
    .c-chips{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }
    .c-chip{
      background:var(--brand-50); border:1px solid var(--brand-200); color:#2c2c2c;
      padding:.55rem .85rem; border-radius:999px; font-size:1em; min-height:44px;
      display:flex; align-items:center; cursor:pointer;
    }

    /* Input + botones */
    .c-inputbar{ margin-top:.75rem; display:flex; gap:.5rem; }
    .c-input{
      flex:1; padding:.75rem .95rem; border-radius:12px; border:1px solid #d1d5db; font-size:1em;
      background:#fff;
    }
    .c-btn{
      background:var(--brand); color:#fff; border:none;
      padding:.75rem 1rem; border-radius:12px; font-weight:700; font-size:1em; min-height:44px; cursor:pointer;
    }
    .c-btn:hover{ filter:brightness(.96); }

    .c-tools{ margin:.6rem 0 0; display:flex; justify-content:center; }
    .c-toolbtn{
      background:#f7f7f8; border:1px solid var(--border); color:#1f2937;
      padding:.6rem .9rem; border-radius:10px; font-size:1em; min-height:44px; cursor:pointer;
    }

    .c-foot{ color:var(--muted); font-size:.8em; text-align:center; padding:.6rem 0; }

    /* Lectura c√≥moda en pantallas grandes */
    @media (min-width:900px){ .c-bubble{ max-width:70%; } }

    /* Enlaces con el verde lima corporativo */
    a{ color:var(--accent); }
    a:hover{ text-decoration:underline; }
  </style>
  <!-- B√∫squeda difusa -->
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
  <div class="c-wrap">
    <div class="c-header">
      <div class="c-brand">
        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Escudo CEVP">
        <div>
          <div class="c-title">Asistente ‚Äì CEVP</div>
          <div class="c-sub">Torre Pacheco ¬∑ Secretar√≠a (9:00‚Äì18:00)</div>
        </div>
      </div>
    </div>

    <div id="chat" class="c-chat" aria-live="polite"></div>

    <div class="c-inputbar">
      <input id="msg" class="c-input" type="text" placeholder="Escribe tu pregunta (ej.: comedor, calendario, libros‚Ä¶)" aria-label="Escribe tu pregunta" />
      <button id="send" class="c-btn" aria-label="Enviar mensaje">Enviar</button>
    </div>

    <div class="c-tools">
      <button class="c-toolbtn" id="clear">Borrar conversaci√≥n</button>
    </div>

    <div class="c-foot">
      ‚ö†Ô∏è No compartas datos personales. Para gestiones con datos, usa el correo oficial del centro.
    </div>
  </div>

  <script>
window.addEventListener('DOMContentLoaded', () => {
  const BASE   = 'https://web.virgendelpasico.net';
  const LS_KEY = 'cevp_chat_history_v1';

  const chat     = document.getElementById('chat');
  const input    = document.getElementById('msg');
  const sendBtn  = document.getElementById('send');
  const clearBtn = document.getElementById('clear');

  let awaitingConsentForChips = false;
  let fuse = null;
  let data = [];

  /* -------- utilidades base -------- */
  function stripAccents(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

  function fixLinks(scope){
    scope.querySelectorAll('a[href]').forEach(a=>{
      let href=a.getAttribute('href')||'';
      if (href.startsWith('/')) { href = BASE + href; a.setAttribute('href', href); }
      if (/^(https?:|mailto:|tel:)/i.test(href)) { a.target='_blank'; a.rel='noopener noreferrer'; }
    });
  }

  function saveMessage(html, who){
    try{
      const d = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
      d.push({ html, who, ts: Date.now() });
      localStorage.setItem(LS_KEY, JSON.stringify(d));
    }catch{}
  }

  function addBubble(html, who='bot', save=true){
    const row = document.createElement('div');
    row.className = 'c-row' + (who==='user' ? ' c-user' : '');
    const b = document.createElement('div');
    b.className = 'c-bubble' + (who==='user' ? '' : ' c-bot');
    b.innerHTML = html;
    row.appendChild(b);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
    fixLinks(b);
    if (save) saveMessage(html, who);
    return b;
  }

  function loadHistory(){
    try{ (JSON.parse(localStorage.getItem(LS_KEY)||'[]')).forEach(m=>addBubble(m.html,m.who,false)); }catch{}
  }
  function clearHistory(){ localStorage.removeItem(LS_KEY); chat.innerHTML=''; greet(); }

  function addChips(labels){
    if (!labels || !labels.length) return;
    const wrap=document.createElement('div'); wrap.className='c-chips';
    labels.forEach(t=>{ const c=document.createElement('div'); c.className='c-chip'; c.textContent=t; c.onclick=()=>handleChip(t); wrap.appendChild(c); });
    chat.appendChild(wrap); chat.scrollTop=chat.scrollHeight;
  }
  function getSuggestions(){ return ['Horarios','Calendario','Comedor','Extraescolares','Libros y material','Transporte','Hablar con una persona']; }

  function handleChip(t){
    if (t==='Hablar con una persona'){
      addBubble(t,'user');
      addBubble('üìû Secretar√≠a: <a href="tel:+34968336433">968 33 64 33</a> ¬∑ <a href="mailto:secretaria@virgendelpasico.net">secretaria@virgendelpasico.net</a> (9:00‚Äì14:00)','bot');
      return;
    }
    addBubble(t,'user'); showReply( respond(t) );
  }

  function greet(){
    addBubble('üëã Hola, soy el asistente del cole. Dime qu√© necesitas y te ayudo.<br><br>¬øQuieres que te muestre algunos temas frecuentes? Responde <b>‚ÄúS√≠‚Äù</b> (o ‚Äúvale‚Äù, ‚Äúok‚Äù).');
    awaitingConsentForChips = true;
  }

  function showReply(obj){ addBubble(obj.html,'bot'); if (obj.options?.length) addChips(obj.options); }

  /* -------- b√∫squeda (Fuse) + fallback -------- */
  function initFuse(){
    if (typeof Fuse==='undefined') return;
    fuse = new Fuse(data, {
      includeScore: true,
      threshold: 0.50,           // m√°s permisivo
      keys: [
        { name:'pregunta',  weight:0.6 },
        { name:'tema',      weight:0.2 },
        { name:'etiquetas', weight:0.2 }
      ]
    });
  }

  function keywordFallback(q){
    const has = (s,k) => stripAccents(String(s||'').toLowerCase()).includes(k);
    const pick = (pred) => data.find(pred);

    const tryKeyword = (k, tema) => {
      if (!q.includes(k)) return null;
      // 1) por tema
      let item = pick(x => has(x.tema, tema));
      if (item) return { html:item.respuesta, options:[] };
      // 2) por etiquetas
      item = pick(x => Array.isArray(x.etiquetas) && x.etiquetas.some(t => has(t,k)));
      if (item) return { html:item.respuesta, options:[] };
      return null;
    };

    return (
      tryKeyword('calendario','calendario') ||
      tryKeyword('horario','horario')       ||
      tryKeyword('comedor','comedor')       ||
      tryKeyword('libros','libros')         ||
      tryKeyword('material','material')     ||
      tryKeyword('extraescolar','extraescolar') ||
      tryKeyword('transporte','transporte')
    );
  }

  function respond(text){
    // manejo de S√≠/No del saludo
    if (awaitingConsentForChips){
      const t = stripAccents(text.toLowerCase().trim());
      const afirm = ['si','s√≠','vale','ok','de acuerdo','claro','por supuesto'].map(stripAccents);
      const neg   = ['no','nop','negativo'];
      if (afirm.includes(t)) { awaitingConsentForChips = false; return { html:'Perfecto üëç Te dejo algunos temas por si te orienta üëá', options:getSuggestions() }; }
      if (neg.includes(t))   { awaitingConsentForChips = false; return { html:'Perfecto, pues dime qu√© necesitas. üôÇ', options:[] }; }
      // si no es s√≠/no, seguimos con b√∫squeda
      awaitingConsentForChips = false;
    }

    // acceso r√°pido a contacto humano
    if (/(humano|persona|secretar)/i.test(text)){
      return { html:'üìû Secretar√≠a: <a href="tel:+34968336433">968 33 64 33</a> ¬∑ <a href="mailto:secretaria@virgendelpasico.net">secretaria@virgendelpasico.net</a> (9:00‚Äì14:00)', options:[] };
    }

    const q = stripAccents(text.toLowerCase().trim());

    // 1) Intentar con Fuse
    const res = (fuse ? fuse.search(text) : []).slice(0,1);

    // 2) Si no hay resultado claro, probar fallback por palabra clave
    if (!res.length || res[0].score > 0.70){
      const fb = keywordFallback(q);
      if (fb) return fb;
      return { html:'No estoy del todo seguro ü§î. Prueba con una palabra clave (p. ej., ‚Äúcomedor‚Äù, ‚Äúcalendario‚Äù) o dime un poco m√°s.', options:getSuggestions() };
    }

    // 3) Aceptar el mejor resultado
    const hit = res[0].item;
    return { html: hit.respuesta, options:[] };
  }

  /* -------- flujo de arranque -------- */
  function init(){ const hasHist = !!localStorage.getItem(LS_KEY); if (hasHist) loadHistory(); else greet(); }

  // Cargar FAQs y arrancar
  fetch('./faqs.json', { cache:'no-store' })
    .then(r => r.json())
    .then(json => { data = json || []; initFuse(); init(); })
    .catch(()   => { data = []; init(); });

  /* -------- eventos UI -------- */
  sendBtn.addEventListener('click', () => {
    const text = (input.value || '').trim(); if (!text) return;
    addBubble(text,'user'); input.value = '';
    const reply = respond(text); showReply(reply);
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  clearBtn.addEventListener('click', clearHistory);
});
</script>

</body>
</html>
