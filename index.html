<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Asistente ‚Äì CEVP</title>
  <style>
    :root{
      --bg:#fff; --text:#0f172a; --muted:#475569; --primary:#2563eb; --bubble:#eef2ff; --border:#e5e7eb;
      --fs: clamp(17px, 3.2vw, 19px); /* grande y legible en m√≥vil */
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0; background:var(--bg);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-size: var(--fs); line-height:1.5; color: var(--text);
    }

    .wrap{ width:100%; max-width:820px; margin:0 auto; padding:12px; }

    .header{
      display:flex; align-items:center; gap:.75rem;
      padding: 4px 0 10px; border-bottom:1px solid var(--border);
      background:#f8fbff; position: sticky; top:0; z-index:5;
    }
    .brand{ display:flex; align-items:center; gap:.75rem; }
    .brand img{ width:40px; height:40px; border-radius:8px; object-fit:cover; }
    .title{ font-weight:800; }
    .subtitle{ color:var(--muted); font-size:.9em; }

    .chat{ margin-top:12px; max-height: 60vh; overflow-y:auto; padding-right:2px; }
    .row{ display:flex; margin:.6rem 0; }
    .row.user{ justify-content:flex-end; }
    .bubble{
      max-width: 92%;
      padding:.75rem .9rem; border-radius:14px;
      font-size: 1em; line-height:1.5; word-wrap:break-word;
    }
    .bubble.bot{ background:var(--bubble); border:1px solid var(--border); }
    .bubble.user{ background:var(--primary); color:#fff; }

    .chips{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }
    .chip{
      background:#eef2ff; border:1px solid var(--border); color:#1f2937;
      padding:.55rem .8rem; border-radius:999px; font-size:1em; min-height:44px;
      display:flex; align-items:center; cursor:pointer;
    }

    .inputbar{ margin-top:.75rem; display:flex; gap:.5rem; }
    input[type="text"]{
      flex:1; padding:.75rem .9rem; border-radius:12px; border:1px solid #d1d5db; font-size:1em;
    }
    button{
      background:var(--primary); color:#fff; border:none;
      padding:.75rem 1rem; border-radius:12px; font-weight:700; font-size:1em; min-height:44px; cursor:pointer;
    }

    .tools{ margin:.6rem 0 0; display:flex; justify-content:center; }
    .toolbtn{
      background:#f3f4f6; border:1px solid var(--border); color:#1f2937;
      padding:.6rem .9rem; border-radius:10px; font-size:1em; min-height:44px; cursor:pointer;
    }

    .footer{ color:var(--muted); font-size:.8em; text-align:center; padding:.6rem 0; }
    @media (min-width:900px){ .bubble{ max-width:70%; } }
    a{ color:#1d4ed8; }
  </style>
  <!-- Fuse.js para b√∫squeda difusa -->
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <img src="https://web.virgendelpasico.net/wp-content/uploads/2024/01/cropped-ncoop-scaled-1-300x253.jpg" alt="Escudo CEVP">
        <div>
          <div class="title">Asistente ‚Äì CEVP Virgen del Pasico</div>
          <div class="subtitle">Torre Pacheco (Murcia) ¬∑ Secretar√≠a (9:00‚Äì14:00)</div>
        </div>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="inputbar">
      <input id="msg" type="text" placeholder="Escribe tu pregunta (ej.: comedor, calendario, libros‚Ä¶)" aria-label="Escribe tu pregunta" />
      <button id="send" aria-label="Enviar mensaje">Enviar</button>
    </div>

    <div class="tools">
      <button class="toolbtn" id="clear">Borrar conversaci√≥n</button>
    </div>

    <div class="footer">
      ‚ö†Ô∏è No compartas datos personales. Para gestiones con datos, usa el correo oficial del centro.
    </div>
  </div>

  <script>
    const BASE = 'https://web.virgendelpasico.net';
    const LS_KEY = 'cevp_chat_history_v1';
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');

    let awaitingConsentForChips = false;
    let fuse = null; // buscador
    let data = [];   // FAQs

    // 1) Cargar faqs.json (mismo directorio)
    fetch('./faqs.json')
      .then(r => r.json())
      .then(json => {
        data = json;
        fuse = new Fuse(data, {
          includeScore: true,
          threshold: 0.38,
          keys: [
            {name:'pregunta', weight:0.6},
            {name:'tema',      weight:0.2},
            {name:'etiquetas', weight:0.2},
          ]
        });
        init();
      })
      .catch(() => init());

    // 2) Utilidades
    function loadHistory(){ try{ (JSON.parse(localStorage.getItem(LS_KEY)||'[]')).forEach(m=>addBubble(m.html,m.who,false)); }catch{} }
    function saveMessage(html,who){ try{ const d=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); d.push({html,who,ts:Date.now()}); localStorage.setItem(LS_KEY,JSON.stringify(d)); }catch{} }
    function clearHistory(){ localStorage.removeItem(LS_KEY); chat.innerHTML=''; greet(); }

    function fixLinks(scope){
      scope.querySelectorAll('a[href]').forEach(a=>{
        let href = a.getAttribute('href')||'';
        if (href.startsWith('/')) { href = BASE + href; a.setAttribute('href', href); }
        if (/^(https?:|mailto:|tel:)/i.test(href)) { a.target = '_blank'; a.rel = 'noopener noreferrer'; }
      });
    }

    function addBubble(html, who='bot', save=true){
      const row = document.createElement('div');
      row.className = 'row ' + (who==='user'?'user':'');
      const b = document.createElement('div');
      b.className = 'bubble ' + (who==='user'?'user':'bot');
      b.innerHTML = html;
      row.appendChild(b);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      fixLinks(b);
      if (save) saveMessage(html, who);
      return b;
    }

    function addChips(labels){
      if (!labels || !labels.length) return;
      const wrap = document.createElement('div'); wrap.className = 'chips';
      labels.forEach(t => {
        const c = document.createElement('div'); c.className='chip'; c.textContent=t;
        c.onclick = () => handleChip(t);
        wrap.appendChild(c);
      });
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    function getSuggestions(){
      return ['Horarios','Calendario','Comedor','Extraescolares','Libros y material','Transporte','Hablar con una persona'];
    }

    function handleChip(t){
      if (t==='Hablar con una persona'){
        addBubble(t,'user');
        addBubble('üìû Secretar√≠a: <a href="tel:+34968336433">968 33 64 33</a> ¬∑ <a href="mailto:secretaria@virgendelpasico.net">secretaria@virgendelpasico.net</a> (9:00‚Äì14:00)','bot');
        return;
      }
      addBubble(t,'user');
      const reply = respond(t);
      showReply(reply);
    }

    function greet(){
      addBubble('üëã Hola, soy el asistente del cole. Dime qu√© necesitas y te ayudo.<br><br>¬øQuieres que te muestre algunos temas frecuentes? Responde <b>‚ÄúS√≠‚Äù</b> (o ‚Äúvale‚Äù, ‚Äúok‚Äù).');
      awaitingConsentForChips = true;
    }

    function init(){
      const hasHist = !!localStorage.getItem(LS_KEY);
      if (hasHist) loadHistory(); else greet();
    }

    function showReply(obj){
      addBubble(obj.html,'bot');
      if (obj.options?.length) addChips(obj.options);
    }

    function respond(text){
      if (awaitingConsentForChips){
        const t = text.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
        const afirm = ['si','s√≠','vale','ok','de acuerdo','claro','por supuesto'];
        const neg   = ['no','nop','negativo'];
        if (afirm.includes(t)) {
          awaitingConsentForChips = false;
          return { html:'Perfecto üëç Te dejo algunos temas por si te orienta üëá', options: getSuggestions() };
        } else if (neg.includes(t)) {
          awaitingConsentForChips = false;
          return { html:'Perfecto, pues dime qu√© necesitas. üôÇ', options: [] };
        } else {
          awaitingConsentForChips = false;
        }
      }

      if (/(humano|persona|secretar)/i.test(text)) {
        return { html:'üìû Secretar√≠a: <a href="tel:+34968336433">968 33 64 33</a> ¬∑ <a href="mailto:secretaria@virgendelpasico.net">secretaria@virgendelpasico.net</a> (9:00‚Äì14:00)', options: [] };
      }

      if (!fuse || !data.length){
        return { html:'Ahora mismo no tengo la base cargada. Prueba en unos segundos.', options: getSuggestions() };
      }

      const res = fuse.search(text).slice(0,1);
      if (!res.length || res[0].score > 0.55){
        return { html:'No estoy del todo seguro ü§î. Prueba con una palabra clave (p. ej., ‚Äúcomedor‚Äù, ‚Äúcalendario‚Äù) o dime un poco m√°s.', options: getSuggestions() };
      }
      const hit = res[0].item;
      return { html: hit.respuesta, options: [] };
    }

    sendBtn.onclick = () => {
      const text = (input.value || '').trim(); if (!text) return;
      addBubble(text,'user'); input.value = '';
      const reply = respond(text); showReply(reply);
    };
    input.addEventListener('keydown', e => { if (e.key==='Enter') sendBtn.click(); });
    clearBtn.addEventListener('click', clearHistory);

    document.addEventListener('click', e => {
      const a = e.target.closest('a[href]'); if(!a) return;
      e.preventDefault();
      const href = a.getAttribute('href') || '';
      const url = href.startsWith('/') ? (BASE + href) : href;
      window.open(url, '_blank','noopener');
    });
  </script>
</body>
</html>